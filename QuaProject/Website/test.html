<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI-HYDRO TECH - Flood Monitoring Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
            color: #ffffff; min-height: 100vh; overflow-x: hidden;
        }
        .dashboard-header {
            background: linear-gradient(90deg, #1e3a8a 0%, #3b82f6 100%);
            padding: 30px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
        }
        .dashboard-header::before {
            content: ''; position: absolute; top: 0; left: -50%; width: 200%; height: 100%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        .dashboard-header h1 { font-size: 2.8rem; font-weight: bold; margin-bottom: 10px; position: relative; z-index: 1; }
        .dashboard-header p { opacity: 0.9; font-size: 1.2rem; position: relative; z-index: 1; margin-bottom: 15px; }
        .status-bar {
            background: rgba(0,0,0,0.3); padding: 20px; display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; gap: 20px;
        }
        .status-item { display: flex; align-items: center; gap: 10px; color: #93c5fd; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-online { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .refresh-button {
            background: linear-gradient(45deg, #10b981, #059669); border: none; color: white; padding: 15px 30px;
            border-radius: 25px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); position: relative; z-index: 1;
        }
        .refresh-button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); }
        .refresh-button.loading { opacity: 0.6; pointer-events: none; }
        .alert-container { max-width: 1400px; margin: 0 auto; padding: 0 25px; }
        .alert-box {
            background: linear-gradient(135deg, #dc2626, #b91c1c); border-radius: 10px; padding: 20px; margin: 20px 0;
            border-left: 5px solid #fbbf24; animation: alertPulse 2s infinite; box-shadow: 0 4px 20px rgba(220, 38, 38, 0.3);
        }
        @keyframes alertPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.9; } }
        .alert-icon { font-size: 1.5rem; margin-right: 10px; }
        .status-cards {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px; padding: 25px; max-width: 1400px; margin: 0 auto;
        }
        .status-card {
            background: linear-gradient(145deg, #1f2937, #111827); border-radius: 15px; padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease; text-align: center; position: relative; overflow: hidden;
        }
        .status-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b, #ef4444); opacity: 0.7;
        }
        .status-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.4); }
        .status-value {
            font-size: 2.5rem; font-weight: bold; margin-bottom: 10px;
            background: linear-gradient(45deg, #3b82f6, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .status-label { color: #9ca3af; font-size: 0.9rem; text-transform: uppercase; font-weight: 600; }
        .main-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px; padding: 25px; max-width: 1400px; margin: 0 auto;
        }
        .card {
            background: linear-gradient(145deg, #1f2937, #111827); border-radius: 15px; padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, #3b82f6, #10b981, #f59e0b, #ef4444); opacity: 0.7;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,0.4); }
        .card-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 20px; color: #93c5fd; }
        .metric-value {
            font-size: 3rem; font-weight: bold; margin-bottom: 10px;
            background: linear-gradient(45deg, #3b82f6, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .metric-unit { font-size: 1.2rem; color: #9ca3af; margin-left: 10px; }
        .metric-status { padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; display: inline-block; margin-top: 10px; }
        .status-normal { background: rgba(16, 185, 129, 0.2); color: #10b981 !important; }
        .status-watch { background: rgba(245, 158, 11, 0.2); color: #f59e0b !important; }
        .status-warning { background: rgba(239, 68, 68, 0.2); color: #ef4444 !important; }
        .status-critical { background: rgba(220, 38, 127, 0.2); color: #dc2671 !important; }
        .chart-container { position: relative; height: 300px; margin-bottom: 20px; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .data-table th { color: #93c5fd; font-weight: 600; background: rgba(0,0,0,0.2); }
        .data-table tr:hover { background: rgba(255,255,255,0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-item { text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .stat-number { font-size: 1.8rem; font-weight: bold; color: #3b82f6; margin-bottom: 5px; }
        .stat-label { font-size: 0.8rem; color: #9ca3af; }
        .loading { text-align: center; padding: 40px; color: #9ca3af; }
        .error-message { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; color: #fecaca; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .float-sensor-container {
            position: relative; width: 200px; height: 140px; margin: 20px auto;
            background: linear-gradient(to bottom, transparent 0%, transparent 40%, rgba(59, 130, 246, 0.3) 40%, rgba(59, 130, 246, 0.6) 100%);
            border-radius: 15px; border: 3px solid rgba(59, 130, 246, 0.5); overflow: hidden; transition: all 0.8s ease; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .float-sensor-container.high {
            background: linear-gradient(to bottom, rgba(59, 130, 246, 0.3) 0%, rgba(59, 130, 246, 0.6) 20%, rgba(59, 130, 246, 0.8) 100%);
            box-shadow: 0 12px 40px rgba(239, 68, 68, 0.3);
        }
        .float-sensor-water {
            position: absolute; bottom: 0; left: 0; right: 0;
            background: linear-gradient(to top, rgba(59, 130, 246, 0.8) 0%, rgba(59, 130, 246, 0.4) 100%);
            transition: height 1.2s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 0 0 12px 12px;
        }
        .float-sensor-water.low { height: 25%; animation: waterRipple 3s ease-in-out infinite; }
        .float-sensor-water.high { height: 75%; animation: waterRipple 2s ease-in-out infinite, waterRise 0.8s ease-out; }
        @keyframes waterRipple {
            0%, 100% {
                box-shadow: inset 0 3px 6px rgba(255,255,255,0.3), 0 0 30px rgba(59, 130, 246, 0.3);
            }
            50% {
                box-shadow: inset 0 6px 12px rgba(255,255,255,0.5), 0 0 45px rgba(59, 130, 246, 0.5);
            }
        }
        @keyframes waterRise { 0% { height: 25%; } 100% { height: 75%; } }
        .float-buoy {
            position: absolute; width: 35px; height: 20px; background: linear-gradient(45deg, #fbbf24, #f59e0b);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; border: 3px solid #d97706; left: 50%;
            transform: translateX(-50%); transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .float-buoy.low { bottom: 18%; animation: floatBob 3s ease-in-out infinite; }
        .float-buoy.high { bottom: 68%; animation: floatBob 2s ease-in-out infinite, floatRise 0.8s ease-out; }
        @keyframes floatBob { 0%, 100% { transform: translateX(-50%) translateY(0px); } 50% { transform: translateX(-50%) translateY(-5px); } }
        @keyframes floatRise { 0% { bottom: 18%; } 100% { bottom: 68%; } }
        .float-sensor-label {
            position: absolute; top: -8px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; color: #9ca3af;
            font-weight: 600; background: rgba(0,0,0,0.8); padding: 4px 12px; border-radius: 12px; white-space: nowrap;
        }
        .float-status-indicator { display: inline-block; width: 14px; height: 14px; border-radius: 50%; margin-left: 10px; transition: all 0.3s ease; }
        .float-status-indicator.low { background: #10b981; animation: pulse 2s infinite; }
        .float-status-indicator.high { background: #ef4444; animation: pulse 1s infinite, alertFlash 0.5s ease-in-out infinite alternate; }
        @keyframes alertFlash { 0% { background: #ef4444; } 100% { background: #dc2626; } }
        .float-sensor-container::before {
            content: 'HIGH'; position: absolute; top: 20%; right: 8px; font-size: 0.7rem; color: rgba(255,255,255,0.6); font-weight: 600;
        }
        .float-sensor-container::after {
            content: 'LOW'; position: absolute; bottom: 20%; right: 8px; font-size: 0.7rem; color: rgba(255,255,255,0.6); font-weight: 600;
        }
        @media (max-width: 768px) {
            .status-cards { grid-template-columns: 1fr; padding: 15px; }
            .main-grid { grid-template-columns: 1fr; padding: 15px; }
            .status-bar { flex-direction: column; gap: 10px; }
            .dashboard-header h1 { font-size: 2rem; }
            .status-value, .metric-value { font-size: 2rem; }
            .float-sensor-container { width: 160px; height: 110px; }
            .float-buoy { width: 28px; height: 16px; }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <h1>🌊 BI-HYDRO TECH</h1>
        <p>Advanced Flood Detection & Monitoring System</p>
        <button class="refresh-button" onclick="refreshData()">🔄 Refresh Data</button>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <div class="status-indicator status-online" id="systemStatus"></div>
            <span>System Status: <span id="systemStatusText">Online</span></span>
        </div>
        <div class="status-item">
            <span>Last Update: <span id="lastUpdate">--</span> (Malaysia Time)</span>
        </div>
        <div class="status-item">
            <div class="status-indicator status-online" id="timeSyncIndicator"></div>
            <span>Time Sync: <span id="timeSyncStatus">Syncing...</span></span>
        </div>
        <div class="status-item">
            <span>Total Records: <span id="totalRecords">--</span></span>
        </div>
        <div class="status-item">
            <span>Valid Readings: <span id="validReadings">--</span>%</span>
        </div>
    </div>

    <div class="alert-container">
        <div id="alertContainer"></div>
    </div>

    <!-- Status Cards Section -->
    <div class="status-cards">
        <div class="status-card">
            <div class="status-value" id="waterDistance">--</div>
            <div class="status-label">💧 Water Level (m)</div>
        </div>
        <div class="status-card">
            <div class="status-value" id="waterLevel">--</div>
            <div class="status-label">🌊 Water Level Status</div>
        </div>
        <div class="status-card">
            <div class="status-value" id="rainIntensity">--</div>
            <div class="status-label">🌧️ Rain Intensity (mm/h)</div>
        </div>
        <div class="status-card">
            <div class="status-value" id="floatStatus">--</div>
            <div class="status-label">🎈 Float Status</div>
        </div>
    </div>

    <div class="main-grid">
        <!-- Water Level Distance -->
        <div class="card">
            <h3 class="card-title">💧 Water Level</h3>
            <div class="metric-value" id="waterDistanceDetail">--</div>
            <span class="metric-unit">m</span>
            <div class="metric-status" id="distanceStatus">Normal</div>
            <div style="margin-top: 20px; color: #9ca3af;">
                <div>Sensor Status: <span id="ultrasonicValid">--</span></div>
                <div>Last Reading: <span id="lastReading">--</span> (Malaysia Time)</div>
            </div>
        </div>

        <!-- Water Level Status -->
        <div class="card">
            <h3 class="card-title">🌊 Water Level Status</h3>
            <div class="metric-value" id="waterLevelDetail">NORMAL</div>
            <div class="metric-status" id="waterLevelStatus">Safe</div>
            <div style="margin-top: 20px;">
                <div style="margin: 10px 0; color: #9ca3af;">Normal: < 0.2m</div>
                <div style="margin: 10px 0; color: #9ca3af;">Watch: 0.2-0.5m</div>
                <div style="margin: 10px 0; color: #9ca3af;">Warning: 0.5-0.8m</div>
                <div style="margin: 10px 0; color: #9ca3af;">Critical: > 0.8m</div>
            </div>
        </div>

        <!-- Rain Intensity -->
        <div class="card">
            <h3 class="card-title">🌧️ Rain Intensity</h3>
            <div class="metric-value" id="rainIntensityDetail">--</div>
            <span class="metric-unit">mm/h</span>
            <div class="metric-status" id="rainStatus">No Rain</div>
            <div style="margin-top: 15px;">
                <div>Current Hour: <span id="rain1H">0</span> mm</div>
                <div>Total: <span id="rainTotal">0</span> mm</div>
            </div>
        </div>

        <!-- Float Status -->
        <div class="card">
            <h3 class="card-title">🎈 Float Sensor Status</h3>

            <!-- Animated Float Sensor Visualization -->
            <div class="float-sensor-container" id="floatSensorContainer">
                <div class="float-sensor-label">Float Sensor</div>
                <div class="float-sensor-water" id="floatWater"></div>
                <div class="float-buoy" id="floatBuoy"></div>
            </div>

            <div class="metric-value" id="floatStatusDetail">LOW<span class="float-status-indicator low" id="floatIndicator"></span></div>
            <div class="metric-status" id="floatAlarmStatus">Normal</div>
            <div style="margin-top: 15px;">
                <div>Raw GPIO: <span id="floatRaw">--</span></div>
                <div>State Confirmed: <span id="floatConfirmed">--</span></div>
                <div>Alarm Active: <span id="floatAlarm">No</span></div>
            </div>
        </div>

        <!-- Water Level Trend Chart -->
        <div class="card">
            <h3 class="card-title">📊 Water Level Trend (15-Min Intervals)</h3>
            <div class="chart-container">
                <canvas id="waterLevelChart"></canvas>
            </div>
            <div style="margin-top: 15px; color: #9ca3af; font-size: 0.9rem;">
                <div>📈 Shows average water levels in 15-minute intervals over the last 6 hours</div>
            </div>
        </div>

        <!-- Water Status Distribution Chart (NEW) -->
        <div class="card">
            <h3 class="card-title">🌊 Water Level Status Distribution</h3>
            <div class="chart-container">
                <canvas id="waterStatusChart"></canvas>
            </div>
            <div style="margin-top: 15px; color: #9ca3af; font-size: 0.9rem;">
                <div>📊 Shows percentage of time spent in each water level status</div>
            </div>
        </div>

        <!-- Rain Intensity Chart (NEW) -->
        <div class="card">
            <h3 class="card-title">🌧️ Hourly Rainfall Intensity</h3>
            <div class="chart-container">
                <canvas id="rainIntensityChart"></canvas>
            </div>
            <div style="margin-top: 15px; color: #9ca3af; font-size: 0.9rem;">
                <div>📊 Shows average rainfall per hour over the last 24 hours</div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px;">
                    <span>🟢 No Rain (0mm)</span>
                    <span>🔵 Light (0-10mm)</span>
                    <span>🟡 Moderate (10-30mm)</span>
                    <span>🔴 Heavy (30-60mm)</span>
                    <span>🟣 Very Heavy (60mm+)</span>
                </div>
            </div>
        </div>

        <!-- System Statistics -->
        <div class="card">
            <h3 class="card-title">📈 System Statistics</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="totalReadings">0</div>
                    <div class="stat-label">Total Readings</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="avgDistance">0</div>
                    <div class="stat-label">Avg Distance</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="floatAlarms">0</div>
                    <div class="stat-label">Float Alarms</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="systemUptime">--</div>
                    <div class="stat-label">Uptime</div>
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Water Status</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody id="statusBreakdown">
                    <tr><td colspan="3" style="text-align: center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Recent Historical Data -->
        <div class="card" style="grid-column: 1 / -1;">
            <h3 class="card-title">📈 Historical Sensor Data</h3>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Level (m)</th>
                            <th>Valid</th>
                            <th>Water Status</th>
                            <th>Rain (mm/h)</th>
                            <th>Float</th>
                            <th>System Status</th>
                        </tr>
                    </thead>
                    <tbody id="recentDataTable">
                        <tr>
                            <td colspan="7" style="text-align: center; color: #6b7280;">Loading historical data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getDatabase, ref, onValue, query, orderByKey, limitToLast } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyArWYq8-Zog6C_kjwXjp_tdhwLTHDatp9Y",
            databaseURL: "https://bi-hydro-tech-2b024-default-rtdb.asia-southeast1.firebasedatabase.app/",
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Time constants/utilities (Malaysia)
        const MALAYSIA_TIMEZONE = 'Asia/Kuala_Lumpur';
        let timeOffset = 0; // Internet time offset (ms)

        function getCurrentMalaysiaTime() {
            return new Date(Date.now() + timeOffset);
        }
        function formatMalaysiaTime(date, options = {}) {
            const defaultOptions = { timeZone: MALAYSIA_TIMEZONE, hour12: false, ...options };
            return date.toLocaleString('en-MY', defaultOptions);
        }
        function formatSyncedMalaysiaTime(options = {}) {
            const malaysiaTime = getCurrentMalaysiaTime();
            const defaultOptions = { timeZone: MALAYSIA_TIMEZONE, hour12: false, ...options };
            return malaysiaTime.toLocaleString('en-MY', defaultOptions);
        }

        // Internet time sync
        async function syncInternetTime() {
            try {
                const timeAPIs = [
                    'https://worldtimeapi.org/api/timezone/Asia/Kuala_Lumpur',
                    'https://timeapi.io/api/Time/current/zone?timeZone=Asia/Kuala_Lumpur',
                    'https://worldtimeapi.org/api/ip'
                ];
                for (const api of timeAPIs) {
                    try {
                        const resp = await fetch(api, { cache: 'no-store' });
                        if (!resp.ok) continue;
                        const data = await resp.json();
                        let serverTime = null;
                        if (data.datetime) serverTime = new Date(data.datetime);
                        else if (data.dateTime) serverTime = new Date(data.dateTime);
                        if (serverTime) {
                            const local = new Date();
                            timeOffset = serverTime.getTime() - local.getTime();
                            updateTimeSyncStatus(true);
                            return;
                        }
                    } catch { /* continue */ }
                }
                updateTimeSyncStatus(false);
            } catch {
                updateTimeSyncStatus(false);
            }
        }
        function updateTimeSyncStatus(synced) {
            const txt = document.getElementById('timeSyncStatus');
            const ind = document.getElementById('timeSyncIndicator');
            txt.textContent = synced ? 'Internet' : 'Browser';
            ind.className = `status-indicator ${synced ? 'status-online' : 'status-warning'}`;
        }

        // Timestamp parsing (neutral; display handles TZ)
        function convertTimestamp(timestamp) {
            const n = parseInt(timestamp, 10);
            return new Date(n < 1e10 ? n * 1000 : n);
        }
        function correctTimezoneOffset(date, offsetHours) {
            return new Date(date.getTime() + (offsetHours * 60 * 60 * 1000));
        }

        // Globals
        let latestData = null;
        let historicalData = [];
        let waterLevelChart = null;
        let waterStatusChart = null;
        let rainIntensityChart = null;

        window.addEventListener('load', function() {
            syncInternetTime();
            initCharts();
            loadData();
            setInterval(loadData, 30000);
            setInterval(syncInternetTime, 3600000); // hourly re-sync
        });

        // Charts init
        function initCharts() {
            initWaterLevelChart();
            initWaterStatusChart();
            initRainIntensityChart();
        }
        function initWaterLevelChart() {
            const ctx = document.getElementById('waterLevelChart').getContext('2d');
            waterLevelChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{
                    label: '15-Min Average Water Level (m)', data: [],
                    borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4, fill: true, pointBackgroundColor: '#3b82f6',
                    pointBorderColor: '#1d4ed8', pointRadius: 4, pointHoverRadius: 6
                }]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } },
                        tooltip: {
                            callbacks: {
                                title: (c) => '15-Min Period: ' + c[0].label.replace('\n', ' '),
                                label: (c) => `Average Level: ${c.raw}m`
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(156, 163, 175, 0.1)' } },
                        y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(156, 163, 175, 0.1)' }, beginAtZero: true,
                            title: { display: true, text: 'Water Level Distance (m)', color: '#9ca3af' } }
                    }
                }
            });
        }
        function initWaterStatusChart() {
            const ctx = document.getElementById('waterStatusChart').getContext('2d');
            waterStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Normal', 'Watch', 'Warning', 'Critical'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#dc2671'],
                        borderWidth: 2, borderColor: '#1f2937'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#9ca3af', padding: 15, usePointStyle: true, pointStyle: 'circle' } },
                        tooltip: {
                            callbacks: {
                                label: (c) => {
                                    const total = c.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = total > 0 ? ((c.raw / total) * 100).toFixed(1) : 0;
                                    return `${c.label}: ${c.raw} readings (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        function initRainIntensityChart() {
            const ctx = document.getElementById('rainIntensityChart').getContext('2d');
            rainIntensityChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{
                    label: 'Hourly Rainfall (mm/h)', data: [],
                    backgroundColor: [], borderColor: [], borderWidth: 1
                }]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#9ca3af' } },
                        tooltip: {
                            callbacks: {
                                title: (c) => 'Hour: ' + c[0].label.replace('\n', ' '),
                                label: (c) => {
                                    const v = c.raw;
                                    let t = 'No Rain';
                                    if (v > 0 && v < 10) t = 'Light Rain';
                                    else if (v >= 10 && v < 30) t = 'Moderate Rain';
                                    else if (v >= 30 && v < 60) t = 'Heavy Rain';
                                    else if (v >= 60) t = 'Very Heavy Rain';
                                    return `Average: ${v} mm/h (${t})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { ticks: { color: '#9ca3af', maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(156, 163, 175, 0.1)' } },
                        y: { ticks: { color: '#9ca3af' }, grid: { color: 'rgba(156, 163, 175, 0.1)' }, beginAtZero: true,
                            title: { display: true, text: 'Rainfall Intensity (mm/h)', color: '#9ca3af' } }
                    }
                }
            });
        }

        // Data load
        function loadData() {
            // latest
            const latestRef = ref(database, 'latest');
            onValue(latestRef, (snapshot) => {
                if (snapshot.exists()) {
                    latestData = snapshot.val();
                    updateCurrentStatus();
                } else {
                    loadMostRecentSensorData();
                }
            }, () => loadMostRecentSensorData());

            // historical
            const sensorRef = query(ref(database, 'sensorData'), orderByKey(), limitToLast(200));
            onValue(sensorRef, (snapshot) => {
                if (!snapshot.exists()) return;
                historicalData = [];
                snapshot.forEach((child) => {
                    const key = child.key;
                    if (key.includes('_FLOAT_ALERT') || key.includes('_ALERT')) return;
                    const t = convertTimestamp(key);
                    historicalData.push({ timestamp: key, time: t, ...child.val() });
                });
                historicalData.sort((a, b) => parseInt(b.timestamp, 10) - parseInt(a.timestamp, 10));
                updateHistoricalDataTable();
                updateCharts();
                updateStatistics();
            }, () => showError("Failed to load historical sensor data"));
        }
        function loadMostRecentSensorData() {
            const sensorRef = query(ref(database, 'sensorData'), orderByKey(), limitToLast(1));
            onValue(sensorRef, (snapshot) => {
                if (!snapshot.exists()) { showError("No data available from Firebase"); return; }
                snapshot.forEach((c) => latestData = c.val());
                updateCurrentStatus();
            });
        }

        // UI updates
        function getStatusClass(status) {
            switch (status?.toUpperCase()) {
                case 'NORMAL': return 'status-normal';
                case 'WATCH': return 'status-watch';
                case 'WARNING': return 'status-warning';
                case 'CRITICAL': return 'status-critical';
                default: return 'status-normal';
            }
        }
        function getRainStatusClass(status) {
            switch (status) {
                case 'NO_RAIN': return 'status-normal';
                case 'LIGHT': return 'status-watch';
                case 'MODERATE': return 'status-warning';
                case 'HEAVY':
                case 'VERY_HEAVY': return 'status-critical';
                default: return 'status-normal';
            }
        }
        function getRainStatusText(status) {
            return (status || 'NO_RAIN').replace('_', ' ').toLowerCase().replace(/\b\w/g, l => l.toUpperCase());
        }
        function formatUptime(timestamp) {
            if (!timestamp) return '--';
            const now = Math.floor(Date.now() / 1000);
            const diff = now - timestamp;
            const hours = Math.floor(diff / 3600);
            const minutes = Math.floor((diff % 3600) / 60);
            return `${hours}h ${minutes}m`;
        }

        function updateCurrentStatus() {
            if (!latestData) return;

            // Distance
            const distanceMm = latestData.ultrasonic?.distance_mm || 0;
            const distanceM = (distanceMm / 1000).toFixed(2);
            document.getElementById('waterDistance').textContent = distanceM;
            document.getElementById('waterDistanceDetail').textContent = distanceM;

            // Water level
            const waterStatus = latestData.ultrasonic?.water_status || 'NORMAL';
            document.getElementById('waterLevel').textContent = waterStatus;
            document.getElementById('waterLevelDetail').textContent = waterStatus;
            const wl = document.getElementById('waterLevelStatus');
            wl.textContent = waterStatus;
            wl.className = `metric-status ${getStatusClass(waterStatus)}`;
            const ds = document.getElementById('distanceStatus');
            ds.textContent = waterStatus;
            ds.className = `metric-status ${getStatusClass(waterStatus)}`;

            // Rain
            const rainIntensity = latestData.rainfall?.intensity_1h_mm || 0;
            const rainStatus = latestData.rainfall?.intensity_status || 'NO_RAIN';
            document.getElementById('rainIntensity').textContent = rainIntensity.toFixed(1);
            document.getElementById('rainIntensityDetail').textContent = rainIntensity.toFixed(1);
            document.getElementById('rain1H').textContent = rainIntensity.toFixed(1);
            document.getElementById('rainTotal').textContent = (latestData.rainfall?.total_mm || 0).toFixed(1);
            const rEl = document.getElementById('rainStatus');
            rEl.textContent = getRainStatusText(rainStatus);
            rEl.className = `metric-status ${getRainStatusClass(rainStatus)}`;

            // Float + animation
            const floatLevel = latestData.float?.water_level || 'LOW';
            const floatAlarm = !!latestData.float?.alarm_active;
            document.getElementById('floatStatus').textContent = floatLevel;
            document.getElementById('floatStatusDetail').innerHTML = `${floatLevel}<span class="float-status-indicator ${floatLevel.toLowerCase()}" id="floatIndicator"></span>`;
            document.getElementById('floatRaw').textContent = latestData.float?.raw_gpio_reading ?? '--';
            document.getElementById('floatConfirmed').textContent = latestData.float?.state_confirmed ? 'Yes' : 'No';
            document.getElementById('floatAlarm').textContent = floatAlarm ? 'YES' : 'No';
            const fa = document.getElementById('floatAlarmStatus');
            fa.textContent = floatAlarm ? 'ALARM' : 'Normal';
            fa.className = `metric-status ${floatAlarm ? 'status-critical' : 'status-normal'}`;
            updateFloatSensorAnimation(floatLevel);

            // Valid + uptime
            const hasValidReading = latestData.ultrasonic?.distance_mm > 0;
            const isExplicitlyValid = latestData.ultrasonic?.is_valid === true;
            const sensorValid = isExplicitlyValid || (hasValidReading && latestData.ultrasonic?.is_valid !== false);
            document.getElementById('ultrasonicValid').textContent = sensorValid ? 'Valid ✅' : 'Invalid ❌';
            document.getElementById('systemUptime').textContent = formatUptime(latestData.system?.upload_time);

            // Last reading / last update (Malaysia time, date+time)
            const timeOpts = { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('lastReading').textContent = formatSyncedMalaysiaTime(timeOpts);
            document.getElementById('lastUpdate').textContent = formatSyncedMalaysiaTime(timeOpts);

            // Status + alerts
            updateSystemStatus();
            updateAlerts();

            console.log(`🇲🇾 Dashboard updated at ${formatSyncedMalaysiaTime(timeOpts)} (Internet-synced Malaysia Time)`);
        }

        function updateFloatSensorAnimation(floatLevel) {
            const container = document.getElementById('floatSensorContainer');
            const water = document.getElementById('floatWater');
            const buoy = document.getElementById('floatBuoy');
            const level = (floatLevel || 'LOW').toUpperCase();
            container.classList.remove('high', 'low');
            water.classList.remove('high', 'low');
            buoy.classList.remove('high', 'low');
            if (level === 'HIGH') {
                container.classList.add('high'); water.classList.add('high'); buoy.classList.add('high');
            } else {
                container.classList.add('low'); water.classList.add('low'); buoy.classList.add('low');
            }
        }

        function updateHistoricalDataTable() {
            const tbody = document.getElementById('recentDataTable');
            tbody.innerHTML = '';

            if (historicalData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280;">No historical data available</td></tr>';
                return;
            }

            const recentData = historicalData.slice(0, 20);
            recentData.forEach((data) => {
                const row = document.createElement('tr');

                const formattedTime = formatMalaysiaTime(data.time, {
                    day: '2-digit', month: '2-digit', year: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });

                const distance = data.ultrasonic?.distance_mm ?? '--';
                const isValid = data.ultrasonic?.is_valid;
                const waterLevel = data.ultrasonic?.water_status || '--';
                const rainIntensity = (typeof data.rainfall?.intensity_1h_mm === 'number') ? data.rainfall.intensity_1h_mm.toFixed(1) : '--';
                const floatStatus = data.float?.water_level || '--';
                const systemStatus = data.system?.status || '--';

                const validIcon = isValid === true ? '✅' : isValid === false ? '❌' : '❓';
                const floatIcon = floatStatus === 'HIGH' ? '🚨' : '✅';

                row.innerHTML = `
                    <td style="font-family: monospace; font-size: 0.85rem;">${formattedTime}</td>
                    <td><strong>${(distance === '--' ? '--' : (distance / 1000).toFixed(2))}</strong>m</td>
                    <td>${validIcon}</td>
                    <td class="${getStatusClass(waterLevel)}"><strong>${waterLevel}</strong></td>
                    <td>${rainIntensity}mm/h</td>
                    <td class="${(floatStatus === 'HIGH') ? 'status-critical' : 'status-normal'}">${floatIcon} ${floatStatus}</td>
                    <td>${systemStatus}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function groupDataByTimeInterval(data, intervalMinutes) {
            if (!data || data.length === 0) return [];
            const intervalMs = intervalMinutes * 60 * 1000;
            const grouped = new Map();

            data.forEach(reading => {
                const roundedTime = new Date(Math.floor(reading.time.getTime() / intervalMs) * intervalMs);
                const key = roundedTime.getTime();
                if (!grouped.has(key)) grouped.set(key, { time: roundedTime, distances: [], rainfalls: [] });

                const g = grouped.get(key);
                if (reading.ultrasonic?.distance_mm > 0 && reading.ultrasonic?.is_valid !== false) {
                    g.distances.push(reading.ultrasonic.distance_mm);
                }
                if (typeof reading.rainfall?.intensity_1h_mm === 'number') {
                    g.rainfalls.push(reading.rainfall.intensity_1h_mm);
                }
            });

            const out = Array.from(grouped.values()).map(g => ({
                time: g.time,
                avgDistance: g.distances.length ? +(g.distances.reduce((a, b) => a + b, 0) / g.distances.length / 1000).toFixed(3) : 0,
                avgRainfall: g.rainfalls.length ? +(g.rainfalls.reduce((a, b) => a + b, 0) / g.rainfalls.length).toFixed(2) : 0
            }));
            out.sort((a, b) => b.time.getTime() - a.time.getTime());
            return out;
        }

        function updateCharts() {
            if (!historicalData.length) return;

            // Water level trend (15 min)
            const fifteen = groupDataByTimeInterval(historicalData, 15).slice(0, 24).reverse();
            waterLevelChart.data.labels = fifteen.map(d => {
                const t = formatMalaysiaTime(d.time, { hour: '2-digit', minute: '2-digit' });
                const dt = formatMalaysiaTime(d.time, { month: '2-digit', day: '2-digit' });
                return `${t}\n${dt}`;
            });
            waterLevelChart.data.datasets[0].data = fifteen.map(d => d.avgDistance);
            waterLevelChart.update('none');

            // Status distribution
            const counts = { NORMAL: 0, WATCH: 0, WARNING: 0, CRITICAL: 0 };
            historicalData.forEach(d => {
                const s = d.ultrasonic?.water_status || 'NORMAL';
                if (counts[s] !== undefined) counts[s]++;
            });
            waterStatusChart.data.datasets[0].data = [counts.NORMAL, counts.WATCH, counts.WARNING, counts.CRITICAL];
            waterStatusChart.update('none');

            // Rain (hourly)
            const hourly = groupDataByTimeInterval(historicalData, 60).slice(0, 24).reverse();
            const vals = hourly.map(d => d.avgRainfall);
            rainIntensityChart.data.labels = hourly.map(d => {
                const t = formatMalaysiaTime(d.time, { hour: '2-digit', minute: '2-digit' });
                const dt = formatMalaysiaTime(d.time, { month: '2-digit', day: '2-digit' });
                return `${t}\n${dt}`;
            });
            rainIntensityChart.data.datasets[0].data = vals;
            rainIntensityChart.data.datasets[0].backgroundColor = vals.map(v => {
                if (v === 0) return 'rgba(16, 185, 129, 0.6)';
                if (v < 10) return 'rgba(59, 130, 246, 0.6)';
                if (v < 30) return 'rgba(245, 158, 11, 0.6)';
                if (v < 60) return 'rgba(239, 68, 68, 0.6)';
                return 'rgba(220, 38, 127, 0.6)';
            });
            rainIntensityChart.data.datasets[0].borderColor = vals.map(v => {
                if (v === 0) return '#10b981';
                if (v < 10) return '#3b82f6';
                if (v < 30) return '#f59e0b';
                if (v < 60) return '#ef4444';
                return '#dc2671';
            });
            rainIntensityChart.update('none');
        }

        function updateStatistics() {
            if (!historicalData.length) return;

            const total = historicalData.length;
            document.getElementById('totalReadings').textContent = total;
            document.getElementById('totalRecords').textContent = total;

            const validDistances = historicalData
                .filter(d => d.ultrasonic?.is_valid !== false && d.ultrasonic?.distance_mm > 0)
                .map(d => d.ultrasonic.distance_mm);
            const avg = validDistances.length ? +(validDistances.reduce((a, b) => a + b, 0) / validDistances.length / 1000).toFixed(3) : 0;
            document.getElementById('avgDistance').textContent = `${avg}m`;

            const floatAlarmCount = historicalData.filter(d => d.float?.alarm_active === true).length;
            document.getElementById('floatAlarms').textContent = floatAlarmCount;

            const validCount = historicalData.filter(d => d.ultrasonic?.is_valid !== false).length;
            document.getElementById('validReadings').textContent = total ? Math.round((validCount / total) * 100) : 0;

            const statusCounts = { NORMAL: 0, WATCH: 0, WARNING: 0, CRITICAL: 0 };
            historicalData.forEach(d => {
                const s = d.ultrasonic?.water_status || 'NORMAL';
                if (statusCounts[s] !== undefined) statusCounts[s]++;
            });
            const breakdown = document.getElementById('statusBreakdown');
            breakdown.innerHTML = '';
            Object.entries(statusCounts).forEach(([status, count]) => {
                const pct = total ? ((count / total) * 100).toFixed(1) : '0';
                breakdown.innerHTML += `
                    <tr>
                        <td class="${getStatusClass(status)}">${status}</td>
                        <td>${count}</td>
                        <td>${pct}%</td>
                    </tr>
                `;
            });
        }

        function updateSystemStatus() {
            const ind = document.getElementById('systemStatus');
            const txt = document.getElementById('systemStatusText');

            let isOnline = false;
            let lastUpdateTime = null;

            if (latestData?.system?.status === 'ONLINE') isOnline = true;

            if (latestData?.system?.upload_time) lastUpdateTime = latestData.system.upload_time;
            if (historicalData.length) {
                const recent = parseInt(historicalData[0].timestamp, 10);
                if (!lastUpdateTime || recent > lastUpdateTime) lastUpdateTime = recent;
            }
            const nowSec = Math.floor(Date.now() / 1000);
            if (lastUpdateTime && (nowSec - lastUpdateTime) < 300) isOnline = true;
            if (!isOnline && (latestData || historicalData.length)) isOnline = true;

            ind.className = `status-indicator ${isOnline ? 'status-online' : 'status-error'}`;
            txt.textContent = isOnline ? 'Online' : 'Offline';
        }

        function showAlert(title, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alertBox = document.createElement('div');
            alertBox.className = 'alert-box';
            alertBox.innerHTML = `<span class="alert-icon">⚠️</span><strong>${title}</strong><br>${message}`;
            alertContainer.appendChild(alertBox);
        }
        function showError(message) {
            const alertContainer = document.getElementById('alertContainer');
            const errorBox = document.createElement('div');
            errorBox.className = 'error-message';
            errorBox.textContent = 'Error: ' + message;
            alertContainer.appendChild(errorBox);
            setTimeout(() => { errorBox.remove(); }, 10000);
        }

        function updateAlerts() {
            if (!latestData) return;
            const ws = latestData.ultrasonic?.water_status;
            if (ws === 'CRITICAL') showAlert('🚨 CRITICAL WATER LEVEL', 'Water level has reached critical threshold!');
            else if (ws === 'WARNING') showAlert('⚠️ WARNING WATER LEVEL', 'Water level is elevated - monitor closely');

            if (latestData.float?.alarm_active) showAlert('🎈 FLOAT ALARM', 'Float sensor indicates high water level!');

            const rainStatus = latestData.rainfall?.intensity_status;
            if (rainStatus === 'HEAVY' || rainStatus === 'VERY_HEAVY') {
                showAlert('🌧️ HEAVY RAINFALL', `Current rainfall intensity: ${rainStatus.replace('_', ' ')}`);
            }

            const hasValidReading = latestData.ultrasonic?.distance_mm > 0;
            const isExplicitlyInvalid = latestData.ultrasonic?.is_valid === false;
            if (isExplicitlyInvalid || (!hasValidReading && latestData.ultrasonic?.distance_mm === 0)) {
                showAlert('📡 SENSOR ISSUE', 'Ultrasonic sensor readings may be invalid');
            }
        }

        // Controls
        window.refreshData = function() {
            const button = document.querySelector('.refresh-button');
            button.classList.add('loading'); button.textContent = '🔄 Refreshing...';
            // onValue listeners will update UI; just simulate loading state
            setTimeout(() => { button.classList.remove('loading'); button.textContent = '🔄 Refresh Data'; }, 1500);
        };

        // Dev helpers (optional)
        window.adjustTimezone = function(offsetHours) {
            console.log(`🔧 Applying ${offsetHours} hour offset to all timestamps...`);
            historicalData.forEach(item => {
                const originalTime = convertTimestamp(item.timestamp);
                item.time = correctTimezoneOffset(originalTime, offsetHours);
            });
            updateHistoricalDataTable();
            updateCharts();
        };

        window.debugFirebase = function() {
            console.log('🔍 Latest:', latestData);
            console.log('🔍 Historical:', historicalData.length);
            console.log('Browser TZ:', Intl.DateTimeFormat().resolvedOptions().timeZone);
            console.log('MY now:', formatSyncedMalaysiaTime({ day:'2-digit', month:'2-digit', year:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' }));
        };
    </script>
</body>
</html>
